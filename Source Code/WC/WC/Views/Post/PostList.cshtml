@using System.Web.UI.WebControls
@using Microsoft.AspNet.Identity
@using Microsoft.AspNet.Identity.Owin
@using WC.Models
@{ var currentUserId = User.Identity.GetUserId(); }
@model List<WC.Data.Post>


<div class="modal fade" id="delete-post-modal" tabindex="-1" role="dialog" aria-labelledby="myModalPostLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalPostLabel">Delete Post</h4>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" id="button-post-close" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-facebook" id="button-post-delete" post-id="">Delete Post</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="delete-comment-modal" tabindex="-1" role="dialog" aria-labelledby="myModalCommentLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalCommentLabel">Delete Comment</h4>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" id="button-comment-close" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-facebook" id="button-comment-delete" comment-id="">Delete Comment</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="edit-modal" tabindex="-1" role="dialog" aria-labelledby="edit-modal-label">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="edit-modal-label">Edit</h4>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <textarea class="form-control" id="message-text"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="button-edit-close" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" id="button-edit" class="btn btn-facebook" data-type="" data-id="">Save changes</button>
            </div>
        </div>
    </div>
</div>

@foreach (var item in Model)
{
    var isPoster = item.UserID.Equals(currentUserId, StringComparison.InvariantCultureIgnoreCase);
    var isOwner = item.PostedOn.Equals(currentUserId, StringComparison.InvariantCultureIgnoreCase);
    var alreadyLike = item.PostLikes.Any(x => x.UserID == currentUserId)
        ? "Unlike"
        : "Like";

    <li id="post-block-@item.PostID" class="timeline-item">
        <div class="panel panel-white">
            <div class="panel-body post-block">
                <div class="timeline-item-header post-header">
                    <img src="@Url.Content(item.User.Profile_Photo.ProfileImageUrl)" alt="">
                    <p>
                        <a href="@Url.Action(item.User.UserName, "Profile")">@item.User.FirstName @item.User.LastName</a>
                        @if (!item.UserID.Equals(item.PostedOn, StringComparison.InvariantCultureIgnoreCase))
                        {
                            <a class="no-decoration">&nbsp;<i class="fa fa-arrow-right"></i>&nbsp;</a>
                            <a href="@Url.Action(item.User1.UserName, "Profile")">@item.User1.FirstName @item.User1.LastName</a>
                        }
                    </p> 
                    @{
                        string with;
                        switch (item.VisibleType)
                        {
                            case 1:
                                with = "Everyone on Cyber";
                                break;
                            case 2:
                                with = item.User1.FirstName + "'s friends";
                                break;
                            default:
                                with = "Only me";
                                break;
                        }
                    }
                    <small><a href="@Url.Action(item.PostID, "Posts")">@item.PostedDate</a>
                    @if (item.UserID != User.Identity.GetUserId())
                    {
                        <span class="fa fa-@item.VisibleType share-with" data-toggle="tooltip" data-placement="right" title="Shared with: @with"></span>
                    }
                    else
                    {
                        Html.RenderPartial("_ChangePostVisibleType", item);
                    }
                    </small>
                    <div class="dropdown post-dropdown-caret pull-right">
                        <a id="drop-@item.PostID" href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                            <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu remove-content pull-left" aria-labelledby="drop-@item.PostID">
                            @if (isPoster)
                            {
                                <li><a href="#" data-toggle="modal" data-target="#edit-modal" data-type="Post" data-id="@item.PostID" class="edit-command"><span class="glyphicon glyphicon-pencil"></span>&nbsp;&nbsp;Edit Post</a></li>
                            }
                            @if (isOwner || isPoster)
                            {
                                <li><a href="#" data-toggle="modal" data-target="#delete-post-modal" class="delete-post-command" post-id="@item.PostID"><span class="glyphicon glyphicon-remove"></span>&nbsp;&nbsp;Delete</a></li>
                            }
                            @if ((isOwner || isPoster) && !isPoster)
                            {
                                <li role="separator" class="divider"></li>
                            }
                            @if (!isPoster)
                            {
                                <li><a href="#" class="report-post-command" post-id="@item.PostID"><span class="glyphicon glyphicon-flag"></span>&nbsp;&nbsp;Report...</a></li>
                            }
                        </ul>
                    </div>
                </div>
                <div class="timeline-item-post">
                    <div class="post-content">
                        <div id="post-content-@item.PostID">
                            <p id="post-edit-@item.PostID" style="white-space: pre-line">@item.PostContent</p>
                        </div>
                        <div class="timeline-options">
                            <a class="post-like" href="#" post-id="@item.PostID" data-toogle="@alreadyLike" data-inprocess="0">
                                <i class="icon-like"></i>
                                <span id="post-like-status-@item.PostID">@alreadyLike</span> (<span id="post-like-count-@item.PostID">@item.PostLikes.Count</span>)
                            </a>
                            <a href="#" class="comment-text" post-id="@item.PostID"><i class="icon-bubble"></i> Comment (<span id="comment-count-@item.PostID">@item.Comments.Count</span>)</a>
                        </div>
                    </div>
                    <div class="post-comment">
                        <div id="comment-list-@item.PostID">
                            @if (item.Comments.Count > 0)
                            {
                                var comments = item.Comments.OrderBy(x => x.CommentedDate);
                                //Html.RenderAction("CommentList", "Home", new { Model = item.Comments as List<WC.Data.Comment> });
                                foreach (var comment in comments)
                                {
                                    var isCommenter = comment.UserID.Equals(currentUserId, StringComparison.InvariantCultureIgnoreCase);
                                    var commentAlreadyLike = comment.CommentLikes.Any(x => x.UserID == User.Identity.GetUserId())
                                                        ? "Unlike"
                                                        : "Like";
                                    <div id="comment-block-@comment.CommentID" class="timeline-comment">
                                        <div class="timeline-comment-header">
                                            <img src="@Url.Content(comment.User.Profile_Photo.ProfileImageUrl)" alt="">
                                            <p>
                                                <a href="@Url.Action(comment.User.UserName, "Profile")">@comment.User.FirstName @comment.User.LastName</a> <span id="comment-edit-@comment.CommentID" style="white-space: pre-line; font-weight: 400">@comment.CommentContent</span>
                                            </p>
                                            <div class="dropdown dropdown-caret pull-right">
                                                <a id="drop-@comment.CommentID" href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                                                    <span class="caret"></span>
                                                </a>
                                                <ul class="dropdown-menu remove-content pull-left" aria-labelledby="drop-@comment.CommentID">
                                                    @if (isCommenter)
                                                    {
                                                        <li><a href="#" data-toggle="modal" data-target="#edit-modal" data-type="Comment" class="edit-command" data-id="@comment.CommentID"><span class="glyphicon glyphicon-pencil"></span>&nbsp;&nbsp;Edit Comment</a></li>
                                                    }
                                                    @if (isOwner || isCommenter)
                                                    {
                                                        <li><a href="#" data-toggle="modal" data-target="#delete-comment-modal" class="delete-comment-command" comment-id="@comment.CommentID"><span class="glyphicon glyphicon-remove"></span>&nbsp;&nbsp;Delete</a></li>
                                                    }
                                                    @if ((isOwner || isCommenter) && !isCommenter)
                                                    {
                                                        <li role="separator" class="divider"></li>
                                                    }
                                                    @if (!isCommenter)
                                                    {
                                                        <li><a href="#" class="report-comment-command" comment-id="@comment.CommentID"><span class="glyphicon glyphicon-flag"></span>&nbsp;&nbsp;Report...</a></li>
                                                    }
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="clear"></div>
                                        <a class="comment-like" href="#" comment-id="@comment.CommentID" data-toogle="@commentAlreadyLike" data-inprocess="0">
                                            <span id="comment-like-status-@comment.CommentID">@commentAlreadyLike</span> (<span id="comment-like-count-@comment.CommentID">@comment.CommentLikes.Count</span>)
                                        </a><small>@comment.CommentedDate</small>
                                    </div>
                                }
                            }
                        </div>
                        <textarea class="form-control comment-form" id="comment-area-@item.PostID" post-id="@item.PostID" placeholder="Write a comment..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </li>
}

